name: iOS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: self-hosted  # ← YOUR Mac builds this!
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Show environment
      run: |
        echo "=== Xcode Version ==="
        xcodebuild -version
        echo "=== macOS Version ==="
        sw_vers
        echo "=== Directory ==="
        ls -la
    
    - name: List schemes
      run: |
        xcodebuild -list -project FinanceApp.xcodeproj
    
    - name: Build project
      run: |
        xcodebuild clean build \
          -project FinanceApp.xcodeproj \
          -scheme FinanceApp \
          -destination 'platform=iOS Simulator,name=iPhone 17' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Run tests
      run: |
        xcodebuild test \
          -project FinanceApp.xcodeproj \
          -scheme FinanceApp \
          -destination 'platform=iOS Simulator,name=iPhone 17' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
      continue-on-error: true

  code-quality:
    name: SwiftLint
    runs-on: self-hosted  # ← Also runs on your Mac
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint || true
      
    - name: Run SwiftLint
      run: swiftlint --reporter github-actions-logging || true

  security:
    name: Security Scan
    runs-on: self-hosted
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Scan for secrets
      run: |
        echo "=== Scanning for hardcoded secrets ==="
        ! grep -r "API_KEY\|SECRET\|PASSWORD" \
          --include="*.swift" . \
          || echo "⚠️ Potential secrets found"
    
    - name: Count lines of code
      run: |
        echo "=== Swift codebase size ==="
        find . -name "*.swift" | xargs wc -l | tail -1